name: Auto Deploy Docker

on:
  push:
    branches: [ "main" ]  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘éƒ¨ç½²

# ==========================================
# ğŸ‘‡ è¯·åœ¨è¿™é‡Œä¿®æ”¹ä½ çš„é¡¹ç›®é…ç½® ğŸ‘‡
# ==========================================
env:
  # 1. GitHub Container Registry é•œåƒå
  #    æ ¼å¼: ghcr.io/ç”¨æˆ·å/é¡¹ç›®å (å…¨å°å†™)
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/openbridge  # å¼ºåˆ¶å°å†™

  # 2. å®¹å™¨åç§°
  CONTAINER_NAME: "openbridge-production"

  # 3. ç«¯å£æ˜ å°„ (æœåŠ¡å™¨ç«¯å£:å®¹å™¨ç«¯å£)
  #    æœåŠ¡å™¨ 8001 ç«¯å£ -> å®¹å™¨å†…éƒ¨ 8080 ç«¯å£
  PORT_MAPPING: "8001:8080"

# ==========================================
# ğŸ‘† ä¿®æ”¹ä¸Šé¢è¿™å‡ è¡Œå°±å¯ä»¥äº†ï¼Œä¸‹é¢ä¸ç”¨åŠ¨ ğŸ‘†
# ==========================================
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. ç™»å½• GitHub Container Registry
      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3. è®¾ç½® Docker Buildx (ä¸ºäº†æ›´å¿«çš„æ„å»ºå’Œå…¼å®¹æ€§)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 4. æ„å»ºé•œåƒå¹¶æ¨é€åˆ° GHCR (æ”¯æŒå¤šæ¶æ„)
      - name: Build and push to GHCR
        uses: docker/build-push-action@v4
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 5. SSH è¿æ¥æœåŠ¡å™¨å¹¶éƒ¨ç½²
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        env:
          CONFIG_CONTENT: ${{ secrets.OPENBRIDGE_CONFIG }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: root  # è¿™é‡Œé»˜è®¤ç”¨ rootï¼Œå¦‚æœä½ ç”¨ ubuntu ç”¨æˆ·è¯·ä¿®æ”¹è¿™é‡Œ
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: CONFIG_CONTENT
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½² OpenBridge..."
            
            # åˆ›å»ºç›®å½• (å¦‚æœä¸å­˜åœ¨)
            mkdir -p /opt/OpenBridge
            
            echo "$CONFIG_CONTENT" > /opt/OpenBridge/config.yaml
            
            echo "âœ… é…ç½®æ–‡ä»¶å·²æ›´æ–°"
            
            # éªŒè¯é…ç½®æ–‡ä»¶ (å¯é€‰)
            ls -lh /opt/OpenBridge/config.yaml
            
            # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨ (å¦‚æœå­˜åœ¨)
            docker stop ${{ env.CONTAINER_NAME }} || true
            docker rm ${{ env.CONTAINER_NAME }} || true
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            
            # å¯åŠ¨æ–°å®¹å™¨ (æŒ‚è½½é…ç½®æ–‡ä»¶)
            docker run -d \
              --name ${{ env.CONTAINER_NAME }} \
              -p ${{ env.PORT_MAPPING }} \
              -v /opt/OpenBridge/config.yaml:/app/config.yaml \
              --restart unless-stopped \
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
              
            echo " OpenBridge éƒ¨ç½²å®Œæˆï¼"
            echo " é…ç½®æ–‡ä»¶è·¯å¾„: /opt/OpenBridge/config.yaml"
            echo " æœåŠ¡è¿è¡Œåœ¨ç«¯å£: 8001"